<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Обработки и формы</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/beige.css" id="theme">
		<link rel="stylesheet" href="plugin/highlight/github.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n--\n$">
                    <script type="text/template">
## Обработка импорта нагрузки

--

### Создание формы обработки

![](images/processing/form-creation.jpg)


--

### Окно редактирование формы

![](images/processing/form-start.jpg)

--

### Добавление элементов форм

![](images/processing/form-add-elem.jpg)

--

### Добавление кнопки

![](images/processing/form-add-button.jpg)

--

### Создание команды

![](images/processing/form-add-command.jpg)

--

### Программирование процедуры импорта

```1C
&НаКлиенте
Процедура ИмпортНагрузки(Команда)
	// Вставить содержимое обработчика.
	Сообщить("Начинается процедура импорта нагрузки");
КонецПроцедуры
```

--

### Результат работы 

![](images/processing/form-result.jpg)

---

## Считываем данные из файла

--

### Структура файла

![](images/processing/file-struct.jpg)

--

### Передаем файл на сервер

```1C
&НаКлиенте
Процедура ИмпортНагрузки(Команда)
	Сообщить("Начинается процедура импорта нагрузки");
	ОповещениеОЗавершении = Новый ОписаниеОповещения(
		"ОбработкаКонцаЗагрузки", ЭтотОбъект);
	НачатьПомещениеФайлаНаСервер(ОповещениеОЗавершении, , ,
		"", "D:\1C\un\НагрузкаAM.xls",УникальныйИдентификатор);	
КонецПроцедуры
```

--

### Обрабатываем файл на сервере

```1C
&НаКлиенте
Процедура ОбработкаКонцаЗагрузки(Файл, Доп) Экспорт
РезультатИмпорта = ИмпортНаСервере(Файл.Адрес);
	Сообщить(РезультатИмпорта);
КонецПроцедуры

&НаСервере
Функция ИмпортНаСервере(Адрес)	
	ДанныеДокумента = ПолучитьИзВременногоХранилища(Адрес);
	ИмяФайла = КаталогВременныхФайлов() + "Нагрузка.xls";
	ДанныеДокумента.Записать(ИмяФайла);

	Возврат ИмяФайла;
КонецФункции
```

--

### Считываем в табличный документ

```1C
Функция ИмпортНаСервере(Адрес)
...
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.Прочитать(ИмяФайла);
	ТабДок.Область(3, 5).Текст = "Дисциплина";
	ТабДок.Область(3, 8).Текст = "Количество";
	ТабДок.Область(3, 10).Текст = "Нагрузка";
	НужнаяОбласть = ТабДок.Область(3, 1, 
		ТабДок.ВысотаТаблицы-1, ТабДок.ШиринаТаблицы);
```

--

### Выгружаем во временную таблицу

```1C
Функция ИмпортНаСервере(Адрес)
...
	МенеджерВТ = Новый МенеджерВременныхТаблиц;
	ЗапросИсходныхДанных = Новый Запрос;
	ЗапросИсходныхДанных.МенеджерВременныхТаблиц = МенеджерВТ;
	ЗапросИсходныхДанных.Текст = "Выбрать
	|	*
	|ПОМЕСТИТЬ ИсходныеДанные
	|из
	|	&НужнаяОбласть КАК НужнаяОбласть";
	ЗапросИсходныхДанных.УстановитьПараметр("НужнаяОбласть", 
		НужнаяОбласть);
	ЗапросИсходныхДанных.Выполнить();
```

--

### Проверяем считывание из файла во временную таблицу

```1C
Функция ИмпортНаСервере(Адрес)
...
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	*
	|ИЗ
	|	ИсходныеДанные");
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
	ИсходныеДанные = Запрос.Выполнить().Выгрузить();
	Возврат ИсходныеДанные.Количество();
```

---

## Импорт ставок и преподавателей. Конструктор.

--

### Виртуальная таблица в запросе

![](images/processing/prep-virt-table.jpg)

--

### Убираем повторы

![](images/processing/prep-group.jpg)

--

### Помещаем во временную таблицу

![](images/processing/prep-unic.jpg)

--

### Создаем пакет запросов

![](images/processing/prep-paket.jpg)

--

### Сопоставляем с имеющимися

![](images/processing/prep-new-and-old.jpg)

--

### Выбираем только новые ставки

![](images/processing/prep-all-new-and-old.jpg)

--

### Помещаем в виртуальную таблицу

![](images/processing/prep-new-table.jpg)

--

### Выбираем только новые ставки

![](images/processing/prep-new.jpg)

--

### Условия для выбора новых ставок

![](images/processing/prep-new-cond.jpg)

---

## Импорт ставок и преподавателей. Код.

--

### Выбор уникальных ставок преподавателей

```1C
&НаСервере
Процедура ИмпортироватьСтавкиИПреподавателей(МенеджерВТ)
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ИсходныеДанные.Преподаватель КАК Преподаватель
	|ПОМЕСТИТЬ ПреподавателиУникальные
	|ИЗ
	|	ИсходныеДанные КАК ИсходныеДанные
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсходныеДанные.Преподаватель
	|;
	|
```

--

### Сопоставление со справочником

```1C
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ПреподавателиСтавки.Наименование КАК Наименование,
|	ПреподавателиУникальные.Преподаватель КАК Преподаватель
|ПОМЕСТИТЬ ПреподавателиНовыеИСправочные
|ИЗ
|	ПреподавателиУникальные КАК ПреподавателиУникальные
|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПреподавателиСтавки 
|			КАК ПреподавателиСтавки
|		ПО ПреподавателиУникальные.Преподаватель = 
|			ПреподавателиСтавки.Наименование
|;
|
```

--

### Выбираем новые ставки

```1C
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ПреподавателиНовыеИСправочные.Преподаватель КАК Преподаватель
|ИЗ
|	ПреподавателиНовыеИСправочные КАК ПреподавателиНовыеИСправочные
|ГДЕ
|	ПреподавателиНовыеИСправочные.Наименование ЕСТЬ NULL");
Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
НовыеСтавки = Запрос.Выполнить().Выгрузить();
```

--

### Записываем новые ставки в справочники

```1C
Для Каждого Ставка Из НовыеСтавки Цикл
	Если Ставка.Преподаватель <> "" Тогда
		// Обработка одного нового преподавателя
	КонецЕсли;
КонецЦикла;
```

--

### Новая запись в справочнике

```1C
НоваяСтавка = Справочники.ПреподавателиСтавки.СоздатьЭлемент();
НоваяСтавка.Наименование = Ставка.Преподаватель;
НоваяСтавка.Записать();
```

--

### Имя преподавателя в наименовании ставки

```1C
ИндексСкобки = СтрНайти(Ставка.Преподаватель, "(");
Если ИндексСкобки = 0 Тогда
	НаименованиеПреподавателя = Ставка.Преподаватель;				
Иначе
	НаименованиеПреподавателя = Лев(Ставка.Преподаватель, 
		ИндексСкобки - 1);
КонецЕсли;
```

--

### Новый ли преподаватель

```1C
ПреподавательСсылка = Справочники.Преподаватели.НайтиПоНаименованию(
	НаименованиеПреподавателя);
Если ПреподавательСсылка.Пустая() Тогда
	НовыйПреподаватель = Справочники.Преподаватели.СоздатьЭлемент();
	НовыйПреподаватель.Наименование = НаименованиеПреподавателя;
	НовыйПреподаватель.Записать();
	ПреподавательСсылка = НовыйПреподаватель.Ссылка;
КонецЕсли;
```

--

### Заполняем табличную часть

```1C
Преподаватель = ПреподавательСсылка.ПолучитьОбъект();
ПреподавательТЧ = Преподаватель.Ставки;
НоваяСтрока = ПреподавательТЧ.Добавить();
НоваяСтрока.Ставка = НоваяСтавка.Ссылка;
Преподаватель.Записать();
```

---

## Добавляем в форму очистку

--

### Поля типа «Булево»

![](images/processing/clear-form.jpg)

--

### Передаем параметры импорта

```1C
&НаКлиенте
Процедура ОбработкаКонцаЗагрузки(Файл, Доп) Экспорт
	ПараметрыИмпорта = Новый Структура();
	ПараметрыИмпорта.Вставить("ИмпортСтавок", 
		ЭтаФорма.ИмпортироватьСтавки);
	РезультатИмпорта = ИмпортНаСервере(Файл.Адрес, ПараметрыИмпорта);
	Сообщить(РезультатИмпорта);
КонецПроцедуры

&НаСервере
Функция ИмпортНаСервере(Адрес, ПараметрыИмпорта)
...
	Если ПараметрыИмпорта.ИмпортСтавок Тогда 
		ИмпортироватьСтавкиИПреподавателей(МенеджерВТ);
	КонецЕсли;
```

--

### Очистка справочников

```1C
&НаСервере
Процедура ОчиститьСправочник(СправочникМенеджер)
	Выборка = СправочникМенеджер.Выбрать();
    Пока Выборка.Следующий() Цикл
        ЭлементСправочника = Выборка.ПолучитьОбъект();
        ЭлементСправочника.Удалить();
    КонецЦикла;	
КонецПроцедуры
```

--

### Очистка справочника

```1C
&НаКлиенте
Процедура Очистка(Команда)
	ОчисткаНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОчисткаНаСервере()
	Если ЭтаФорма.ОчищатьСтавки Тогда
		ОчиститьСправочник(Справочники.СтавкиПреподавателей);
	КонецЕсли;
КонецПроцедуры
```

</script>
                </section>
            </div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>

		<script src="plugin/menu/menu.js"></script>
		<script src="plugin/audio-slideshow/plugin.js"></script>
		<script src="plugin/audio-slideshow/recorder.js"></script>
		<script src="plugin/audio-slideshow/RecordRTC.js"></script>
		<script>
			Reveal.initialize({
				hash: true,
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMenu, RevealAudioSlideshow, RevealAudioRecorder ],
				menu: {
		        	themes: true,
        			themesPath: 'dist/theme/',
		        },
				audio: {
					prefix: 'audio/processing/',
					suffix: '.webm;codecs=opus',
				},
			});
		</script>
	</body>
</html>
